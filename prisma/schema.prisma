// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// TENANT & USER MODELS
// ============================================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  branches            Branch[]
  academicYears       AcademicYear[]
  streams             Stream[]
  classes             Class[]
  cohorts             Cohort[]
  sections            Section[]
  cohortSections      CohortSection[]
  teachers            Teacher[]
  rooms               Room[]
  routines            Routine[]
  users               User[]
  themeSettings       ThemeSettings?
  tenantSettings      TenantSettings?
  students            Student[]
  guardians           Guardian[]
  studentDocuments    StudentDocument[]

  // Course Management Relations
  courseCategories    CourseCategory[]
  courses             Course[]
  courseTopics        CourseTopic[]
  courseLessons       CourseLesson[]
  bundleCourses       BundleCourse[]
  courseFAQs          CourseFAQ[]
  lessonCompletions   LessonCompletion[]

  // File Storage Relations
  uploadedFiles       UploadedFile[]

  studentEnrollments  StudentEnrollment[]
  courseEnrollments   CourseEnrollment[]

  // Subject & Question Bank Relations
  subjects            Subject[]
  chapters            Chapter[]
  topics              Topic[]
  examBoards          ExamBoard[]
  examYears           ExamYear[]
  questionSources     QuestionSource[]
  questions           Question[]

  @@map("tenants")
}

model User {
  id        String   @id @default(cuid())
  tenantId  String
  email     String
  name      String
  username  String?
  password  String?
  role      UserRole @default(STUDENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  routinesCreated Routine[]
  student         Student?

  @@unique([tenantId, email])
  @@unique([tenantId, username])
  @@map("users")
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
}

// ============================================
// ACADEMIC SETUP MODELS
// ============================================

model Branch {
  id        String       @id @default(cuid())
  tenantId  String
  name      String
  code      String?
  address   String?
  phone     String?
  status    BranchStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cohorts     Cohort[]
  enrollments StudentEnrollment[]

  @@unique([tenantId, name])
  @@map("branches")
}

enum BranchStatus {
  ACTIVE
  INACTIVE
}

model AcademicYear {
  id        String            @id @default(cuid())
  tenantId  String
  name      String
  code      String
  startDate DateTime
  endDate   DateTime
  state     AcademicYearState @default(PLANNED)
  isCurrent Boolean           @default(false)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cohorts     Cohort[]
  enrollments StudentEnrollment[]

  @@unique([tenantId, code])
  @@map("academic_years")
}

enum AcademicYearState {
  PLANNED
  ACTIVE
  COMPLETED
  ARCHIVED
}

model Stream {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  classes Class[]
  cohorts Cohort[]
  courses Course[]

  @@unique([tenantId, name])
  @@map("streams")
}

model Class {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  alias     String?
  order     Int
  streamId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stream      Stream?             @relation(fields: [streamId], references: [id], onDelete: SetNull)
  cohorts     Cohort[]
  enrollments StudentEnrollment[]
  chapters    Chapter[]
  courses     Course[]

  @@unique([tenantId, name])
  @@unique([tenantId, order])
  @@map("classes")
}

model Cohort {
  id             String       @id @default(cuid())
  tenantId       String
  yearId         String
  classId        String
  streamId       String?
  branchId       String
  name           String
  status         CohortStatus @default(PLANNED)
  enrollmentOpen Boolean      @default(false)
  startDate      DateTime?
  endDate        DateTime?
  archivedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  tenant Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  year   AcademicYear @relation(fields: [yearId], references: [id], onDelete: Restrict)
  class  Class        @relation(fields: [classId], references: [id], onDelete: Restrict)
  stream Stream?      @relation(fields: [streamId], references: [id], onDelete: SetNull)
  branch Branch       @relation(fields: [branchId], references: [id], onDelete: Restrict)

  // Many-to-many relationship with sections through CohortSection junction table
  cohortSections CohortSection[]
  enrollments    StudentEnrollment[]

  @@unique([tenantId, yearId, classId, streamId, branchId, name])
  @@map("cohorts")
}

enum CohortStatus {
  PLANNED
  ACTIVE
  COMPLETED
  ARCHIVED
}

model Section {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  capacity  Int      @default(0) // 0 = unlimited
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  routines    Routine[]
  enrollments StudentEnrollment[]

  // Many-to-many relationship with cohorts through CohortSection junction table
  cohortSections CohortSection[]

  // Section name must be unique per tenant (sections are now independent resources)
  @@unique([tenantId, name])
  @@map("sections")
}

// Junction table for many-to-many relationship between Cohorts and Sections
model CohortSection {
  id        String   @id @default(cuid())
  tenantId  String
  cohortId  String
  sectionId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cohort  Cohort  @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  // A section can only be linked to a cohort once
  @@unique([tenantId, cohortId, sectionId])
  @@map("cohort_sections")
}

model Teacher {
  id               String   @id @default(cuid())
  tenantId         String
  name             String
  email            String
  phone            String?
  availabilityJson String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  routines Routine[]
  courses  Course[]

  @@unique([tenantId, email])
  @@map("teachers")
}

model Room {
  id        String     @id @default(cuid())
  tenantId  String
  name      String
  capacity  Int?
  status    RoomStatus @default(ACTIVE)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  routines Routine[]

  @@unique([tenantId, name])
  @@map("rooms")
}

enum RoomStatus {
  ACTIVE
  INACTIVE
}

model Routine {
  id              String   @id @default(cuid())
  tenantId        String
  sectionId       String
  teacherId       String
  roomId          String
  courseId        String?
  dayOfWeek       Int // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  startTime       String // Format: "HH:MM"
  endTime         String // Format: "HH:MM"
  createdByUserId String
  createdAt       DateTime @default(now())

  tenant    Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  section   Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Restrict)
  room      Room    @relation(fields: [roomId], references: [id], onDelete: Restrict)
  createdBy User    @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)

  @@map("routines")
}

// ============================================
// THEME SETTINGS MODEL
// ============================================

model ThemeSettings {
  id          String   @id @default(cuid())
  tenantId    String   @unique

  // Theme mode (light/dark/auto)
  mode        String   @default("light") // "light" | "dark" | "auto"

  // Predefined theme or custom
  themeName   String   @default("pink-orange") // "pink-orange", "blue-ocean", "green-forest", "purple-dream", "custom"
  isCustom    Boolean  @default(false)

  // Active state colors
  activeFrom  String   @default("#ec4899") // pink-500
  activeTo    String   @default("#f97316") // orange-500

  // Hover state colors
  hoverFrom   String   @default("#fdf2f8") // pink-50
  hoverTo     String   @default("#fff7ed") // orange-50

  // Border color
  borderColor String   @default("#fbcfe8") // pink-300

  // Button colors
  buttonFrom  String   @default("#ec4899") // pink-500
  buttonTo    String   @default("#f97316") // orange-500

  // Text color override (optional, for custom themes or dark mode)
  hoverTextColor String? // Optional: override hover text color

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("theme_settings")
}

// ============================================
// TENANT SETTINGS MODEL
// ============================================

model TenantSettings {
  id              String   @id @default(cuid())
  tenantId        String   @unique
  enableCohorts   Boolean  @default(true)  // Enable/disable cohort-based enrollment

  // General Settings
  instituteName   String?
  logoUrl         String?
  signatureUrl    String?
  currencyName    String?  @default("USD")
  currencySymbol  String?  @default("$")
  countryCode     String?  @default("US")
  phonePrefix     String?  @default("+1")

  // Email Carrier Settings (SMTP)
  emailEnabled    Boolean  @default(false)
  smtpHost        String?
  smtpPort        Int?
  smtpUser        String?
  smtpPassword    String?
  smtpFromEmail   String?
  smtpFromName    String?
  smtpEncryption  String?  @default("tls") // tls, ssl, none

  // Email Templates (JSON stored as text)
  emailTemplates  String? // JSON: { admissionTemplate, invoiceTemplate, etc. }

  // Payment Methods (JSON stored as text)
  paymentMethods  String? // JSON: { stripe: {...}, paypal: {...}, etc. }

  // Storage Settings
  storageType              String?  @default("LOCAL") // LOCAL, R2
  storageLocalPath         String?  @default("./storage")
  storageR2AccountId       String?
  storageR2AccessKeyId     String?
  storageR2SecretAccessKey String?
  storageR2Bucket          String?
  storageR2PublicUrl       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_settings")
}

// ============================================
// STUDENT MODEL
// ============================================

model Student {
  id              String   @id @default(cuid())
  tenantId        String
  userId          String   @unique

  // Auto-generated student ID (e.g., STU-2025-001)
  studentId       String?

  // Personal Information
  name            String
  email           String?
  phone           String?
  dateOfBirth     DateTime?
  gender          Gender?
  bloodGroup      String?
  photoUrl        String?

  // Address
  presentAddress  String?
  permanentAddress String?

  // Academic Information
  rollNumber      String?
  admissionDate   DateTime @default(now())

  // Previous School (Optional)
  previousSchoolName    String?
  previousSchoolAddress String?
  previousClass         String?
  previousBoard         String?
  tcNumber              String?

  // Previous School Academic Results (JSON array)
  // Format: [{ examName: string, year: string, gpa: string, grade: string }]
  previousAcademicResults String?

  // Status
  status          StudentStatus @default(ACTIVE)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  guardians       Guardian[]
  enrollments     StudentEnrollment[]
  courseEnrollments CourseEnrollment[]
  documents       StudentDocument[]

  @@unique([tenantId, studentId])
  @@unique([tenantId, email])
  @@map("students")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum StudentStatus {
  ACTIVE
  INACTIVE
  GRADUATED
  TRANSFERRED
  DROPPED
}

// Guardian Model
model Guardian {
  id              String   @id @default(cuid())
  tenantId        String
  studentId       String

  name            String
  relationship    String
  phone           String
  email           String?
  occupation      String?
  address         String?
  isPrimary       Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("guardians")
}

// Student Documents
model StudentDocument {
  id              String   @id @default(cuid())
  tenantId        String
  studentId       String

  documentType    String
  fileName        String
  fileUrl         String
  fileSize        Int

  uploadedAt      DateTime @default(now())

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("student_documents")
}

// ============================================
// COURSE MANAGEMENT MODELS
// ============================================

// Course Category
model CourseCategory {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  slug        String
  description String?
  icon        String?
  color       String?
  order       Int      @default(0)
  status      String   @default("ACTIVE") // ACTIVE, INACTIVE
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  courses     Course[]

  @@unique([tenantId, slug])
  @@index([tenantId, status])
  @@map("course_categories")
}

// Main Course Model
model Course {
  id                   String   @id @default(cuid())
  tenantId             String

  // Basic Info
  title                String
  slug                 String
  description          String?
  shortDescription     String?

  // Category & Type
  categoryId           String?
  courseType           String   @default("SINGLE") // SINGLE, BUNDLE

  // Academic Integration (Optional)
  classId              String?
  subjectId            String?
  streamId             String?

  // Author/Instructor
  authorName           String?
  instructorId         String?

  // Pricing
  paymentType          String   @default("ONE_TIME") // ONE_TIME, SUBSCRIPTION, FREE
  invoiceTitle         String?
  regularPrice         Float?
  offerPrice           Float?
  currency             String   @default("BDT")

  // Subscription
  subscriptionDuration Int?
  subscriptionType     String?  // MONTHLY, QUARTERLY, YEARLY, CUSTOM

  // Invoice Settings
  autoGenerateInvoice  Boolean  @default(true)

  // Media
  featuredImage        String?
  introVideoUrl        String?

  // Visibility & Status
  status               String   @default("DRAFT") // DRAFT, PUBLISHED, SCHEDULED, PRIVATE
  publishedAt          DateTime?
  scheduledAt          DateTime?

  // SEO & Meta
  metaTitle            String?
  metaDescription      String?
  metaKeywords         String?

  // Settings
  isFeatured           Boolean  @default(false)
  allowComments        Boolean  @default(true)
  certificateEnabled   Boolean  @default(false)

  // Stats (computed)
  totalTopics          Int      @default(0)
  totalLessons         Int      @default(0)
  totalDuration        Int      @default(0)
  totalEnrollments     Int      @default(0)

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  tenant               Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category             CourseCategory?   @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  class                Class?            @relation(fields: [classId], references: [id], onDelete: SetNull)
  subject              Subject?          @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  stream               Stream?           @relation(fields: [streamId], references: [id], onDelete: SetNull)
  instructor           Teacher?          @relation(fields: [instructorId], references: [id], onDelete: SetNull)
  topics               CourseTopic[]
  enrollments          CourseEnrollment[]
  bundleParent         BundleCourse[]    @relation("BundleParent")
  bundleChild          BundleCourse[]    @relation("BundleChild")
  faqs                 CourseFAQ[]

  @@unique([tenantId, slug])
  @@index([tenantId, status])
  @@index([categoryId])
  @@index([tenantId, classId, subjectId, streamId])
  @@map("courses")
}

// Course Topic
model CourseTopic {
  id          String   @id @default(cuid())
  tenantId    String
  courseId    String
  title       String
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  course      Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     CourseLesson[]

  @@index([courseId])
  @@map("course_topics")
}

// Course Lesson
model CourseLesson {
  id              String   @id @default(cuid())
  tenantId        String
  topicId         String
  title           String
  description     String?
  lessonType      String   // VIDEO_YOUTUBE, VIDEO_VIMEO, VIDEO_LOCAL, VIDEO_GDRIVE, DOCUMENT, TEXT, IFRAME
  order           Int      @default(0)

  // Content URLs
  videoUrl        String?  // YouTube/Vimeo/GDrive URL
  videoFilePath   String?  // Local video file path
  documentPath    String?  // PDF/DOC file path
  textContent     String?  // Rich text content
  iframeUrl       String?  // Embed URL

  // Settings
  duration        Int?     // In minutes
  isPreview       Boolean  @default(false)
  accessType      String   @default("ENROLLED_ONLY") // PUBLIC, PASSWORD, ENROLLED_ONLY
  password        String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  topic           CourseTopic         @relation(fields: [topicId], references: [id], onDelete: Cascade)
  completions     LessonCompletion[]

  @@index([topicId])
  @@map("course_lessons")
}

// Bundle Course (Many-to-Many)
model BundleCourse {
  id          String   @id @default(cuid())
  tenantId    String
  bundleId    String   // Parent course (bundle)
  courseId    String   // Child course (included in bundle)
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bundle      Course   @relation("BundleParent", fields: [bundleId], references: [id], onDelete: Cascade)
  course      Course   @relation("BundleChild", fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([bundleId, courseId])
  @@index([bundleId])
  @@index([courseId])
  @@map("bundle_courses")
}

// Course FAQ
model CourseFAQ {
  id          String   @id @default(cuid())
  tenantId    String
  courseId    String
  question    String
  answer      String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@map("course_faqs")
}

// Lesson Completion Tracking
model LessonCompletion {
  id              String   @id @default(cuid())
  tenantId        String
  enrollmentId    String
  lessonId        String
  completedAt     DateTime @default(now())
  watchDuration   Int?     // In seconds

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  enrollment      CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson          CourseLesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@index([enrollmentId])
  @@index([lessonId])
  @@map("lesson_completions")
}

// ============================================
// ENROLLMENT MODELS
// ============================================

model StudentEnrollment {
  id              String   @id @default(cuid())
  tenantId        String
  studentId       String
  sectionId       String

  // Enrollment Type (based on cohort setting)
  enrollmentType  EnrollmentType @default(DIRECT)
  cohortId        String?  // Only if enrollmentType = COHORT_BASED

  // Academic Info
  academicYearId  String
  classId         String
  branchId        String

  enrollmentDate  DateTime @default(now())
  status          EnrollmentStatus @default(ACTIVE)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  section         Section       @relation(fields: [sectionId], references: [id], onDelete: Restrict)
  cohort          Cohort?       @relation(fields: [cohortId], references: [id], onDelete: Restrict)
  academicYear    AcademicYear  @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  class           Class         @relation(fields: [classId], references: [id], onDelete: Restrict)
  branch          Branch        @relation(fields: [branchId], references: [id], onDelete: Restrict)

  @@unique([tenantId, studentId, academicYearId])
  @@map("student_enrollments")
}

enum EnrollmentType {
  COHORT_BASED
  DIRECT
}

model CourseEnrollment {
  id              String   @id @default(cuid())
  tenantId        String
  studentId       String
  courseId        String

  // Enrollment Details
  enrollmentDate  DateTime @default(now())
  status          String   @default("ACTIVE") // ACTIVE, COMPLETED, DROPPED, EXPIRED

  // Payment Info
  paymentStatus   String   @default("PENDING") // PENDING, PAID, PARTIAL, REFUNDED
  amountPaid      Float?
  invoiceId       String?

  // Progress Tracking
  progressPercent Int      @default(0)
  completedLessons Int     @default(0)
  totalLessons    Int      @default(0)
  lastAccessedAt  DateTime?

  // Completion
  completedAt     DateTime?
  certificateIssued Boolean @default(false)
  certificateUrl  String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  student         Student             @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course          Course              @relation(fields: [courseId], references: [id], onDelete: Restrict)
  lessonCompletions LessonCompletion[]

  @@unique([tenantId, studentId, courseId])
  @@index([studentId])
  @@index([courseId])
  @@map("course_enrollments")
}

enum EnrollmentStatus {
  ACTIVE
  DROPPED
  COMPLETED
}

// ============================================
// SUBJECT & QUESTION BANK MODELS
// ============================================

// Subject Model - Reusable across classes
model Subject {
  id          String        @id @default(cuid())
  tenantId    String
  name        String
  code        String?
  description String?
  icon        String?
  color       String?
  order       Int           @default(0)
  status      SubjectStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  courses  Course[]
  chapters Chapter[]

  @@unique([tenantId, name])
  @@unique([tenantId, order])
  @@index([tenantId, status])
  @@map("subjects")
}

enum SubjectStatus {
  ACTIVE
  INACTIVE
}

// Chapter Model - Subject subdivision by class
model Chapter {
  id          String        @id @default(cuid())
  tenantId    String
  subjectId   String
  classId     String
  name        String
  code        String?
  description String?
  order       Int           @default(0)
  status      ChapterStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  topics  Topic[]

  @@unique([tenantId, subjectId, classId, name])
  @@unique([tenantId, subjectId, classId, order])
  @@index([tenantId, subjectId, classId])
  @@map("chapters")
}

enum ChapterStatus {
  ACTIVE
  INACTIVE
}

// Topic Model - Chapter subdivision
model Topic {
  id          String      @id @default(cuid())
  tenantId    String
  chapterId   String
  name        String
  code        String?
  description String?
  order       Int         @default(0)
  status      TopicStatus @default(ACTIVE)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  chapter   Chapter    @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  questions Question[]

  @@unique([tenantId, chapterId, name])
  @@unique([tenantId, chapterId, order])
  @@index([tenantId, chapterId])
  @@map("topics")
}

enum TopicStatus {
  ACTIVE
  INACTIVE
}

// ExamBoard Model - Master list of exam institutions (boards, colleges, universities) per tenant
model ExamBoard {
  id        String       @id @default(cuid())
  tenantId  String
  name      String
  code      String?
  status    SourceStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  questionSources QuestionSource[]
  questions       Question[]

  @@unique([tenantId, name])
  @@map("exam_boards")
}

// QuestionSource Model - Track legacy question origins (board exams, textbooks, etc.)
model QuestionSource {
  id          String       @id @default(cuid())
  tenantId    String
  boardId     String?
  name        String
  type        SourceType   @default(CUSTOM)
  year        Int?
  description String?
  status      SourceStatus @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  board     ExamBoard? @relation(fields: [boardId], references: [id], onDelete: SetNull)
  questions Question[]

  // For board exam sources, uniqueness is (tenantId, boardId, year).
  // For non-board sources (boardId null), uniqueness is (tenantId, name, type, year).
  @@unique([tenantId, boardId, year])
  @@unique([tenantId, name, type, year])
  @@index([tenantId, type])
  @@map("question_sources")
}

// ExamYear Model - Master list of exam years per tenant
model ExamYear {
  id        String       @id @default(cuid())
  tenantId  String
  year      Int
  label     String?
  status    SourceStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  questions Question[]

  @@unique([tenantId, year])
  @@map("exam_years")
}

enum SourceType {
  BOARD_EXAM
  TEXTBOOK
  REFERENCE_BOOK
  CUSTOM
  PREVIOUS_YEAR
  MOCK_TEST
}

enum SourceStatus {
  ACTIVE
  INACTIVE
}

// Question Model - Individual questions
model Question {
  id             String          @id @default(cuid())
  tenantId       String
  topicId        String
  sourceId       String?
  institutionId  String?
  examYearId     String?
  questionText   String
  questionType   QuestionType    @default(MCQ)
  options        String?
  correctAnswer  String?
  explanation    String?
  difficulty     DifficultyLevel @default(MEDIUM)
  marks          Float           @default(1)
  negativeMarks  Float           @default(0)
  imageUrl       String?
  status         QuestionStatus  @default(ACTIVE)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  topic       Topic           @relation(fields: [topicId], references: [id], onDelete: Cascade)
  source      QuestionSource? @relation(fields: [sourceId], references: [id], onDelete: SetNull)
  institution ExamBoard?      @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  examYear    ExamYear?       @relation(fields: [examYearId], references: [id], onDelete: SetNull)

  @@index([tenantId, topicId])
  @@index([tenantId, sourceId])
  @@index([tenantId, institutionId])
  @@index([tenantId, examYearId])
  @@index([tenantId, difficulty])
  @@index([tenantId, questionType])
  @@map("questions")
}

enum QuestionType {
  MCQ
  TRUE_FALSE
  SHORT_ANSWER
  LONG_ANSWER
  FILL_BLANK
  MATCHING
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
  EXPERT
}

enum QuestionStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

// ============================================
// FILE STORAGE MODELS
// ============================================

model UploadedFile {
  id          String   @id @default(cuid())
  tenantId    String

  // File metadata
  key         String   // Storage key: tenants/{tenantId}/questions/images/{questionId}/123.jpg
  url         String   // Public URL
  fileName    String   // Original filename
  fileSize    Int      // Size in bytes
  mimeType    String   // image/jpeg, application/pdf, etc.

  // Categorization
  category    String   // 'question_image', 'student_photo', 'course_material', etc.
  entityType  String   // 'question', 'student', 'course', etc.
  entityId    String   // ID of the related entity

  // Enhanced Metadata (Moodle-style)
  description String?  // File description
  author      String?  // Author name
  license     String?  // License type (e.g., 'allrightsreserved', 'cc', 'public')
  tags        String?  // Comma-separated tags for search
  folder      String?  // Virtual folder path (e.g., 'Course Materials/Week 1')

  // Image-specific metadata
  altText     String?  // Alt text for images (accessibility)
  width       Int?     // Image width in pixels
  height      Int?     // Image height in pixels

  // Access control
  isPublic    Boolean  @default(false)
  uploadedBy  String?  // User ID who uploaded
  uploadedAt  DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId, entityType, entityId])
  @@index([tenantId, category])
  @@index([tenantId, uploadedBy])
  @@index([tenantId, folder])
  @@map("uploaded_files")
}
