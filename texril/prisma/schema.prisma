generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id               String               @id @default(cuid())
  name             String
  slug             String               @unique
  status           TenantStatus         @default(ACTIVE)
  planId           String?
  currentPeriodEnd DateTime?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  plan             Plan?                @relation(fields: [planId], references: [id])
  domains          TenantDomain[]
  subscriptions    Subscription[]
  apiKeys          ApiKey[]
  users            User[]
  integrations     TenantIntegration[]
  auditEvents      AuditEvent[]

  @@index([status])
}

model TenantDomain {
  id        String   @id @default(cuid())
  tenantId  String
  domain    String
  verified  Boolean  @default(false)
  addedById String?
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  addedBy   User?    @relation("UserAddedDomain", fields: [addedById], references: [id])

  @@unique([tenantId, domain])
  @@index([domain])
}

model Plan {
  id           String         @id @default(cuid())
  code         String         @unique
  name         String
  description  String?
  limits       Json
  priceMonthly Int?
  priceYearly  Int?
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  subscriptions Subscription[]
  tenants       Tenant[]
}

model Subscription {
  id                 String             @id @default(cuid())
  tenantId           String
  planId             String
  status             SubscriptionStatus @default(TRIALING)
  billingProvider    BillingProvider    @default(STRIPE)
  externalId         String?
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  trialEndsAt        DateTime?
  cancelAtPeriodEnd  Boolean            @default(false)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  tenant             Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan               Plan               @relation(fields: [planId], references: [id])

  @@index([externalId])
}

model ApiKey {
  id        String        @id @default(cuid())
  tenantId  String
  keyHash   String        @unique
  label     String?
  status    ApiKeyStatus  @default(ACTIVE)
  lastUsedAt DateTime?
  createdAt DateTime      @default(now())
  tenant    Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model User {
  id           String         @id @default(cuid())
  tenantId     String?
  email        String         @unique
  name         String?
  role         UserRole       @default(EDITOR)
  passwordHash String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  tenant       Tenant?        @relation(fields: [tenantId], references: [id])
  domainsAdded TenantDomain[] @relation("UserAddedDomain")
}

model TenantIntegration {
  id         String            @id @default(cuid())
  tenantId   String
  platformId String
  status     IntegrationStatus @default(NOT_CONNECTED)
  externalId String?
  config     Json?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  tenant     Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  platform   Platform          @relation(fields: [platformId], references: [id])

  @@unique([tenantId, platformId])
}

model Platform {
  id        String            @id @default(cuid())
  code      String            @unique
  name      String
  category  PlatformCategory
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  integrations TenantIntegration[]
}

model AuditEvent {
  id        String   @id @default(cuid())
  actorId   String?
  tenantId  String?
  action    String
  payload   Json?
  createdAt DateTime @default(now())
  actor     User?    @relation(fields: [actorId], references: [id])
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([action])
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  TRIAL
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
}

enum BillingProvider {
  STRIPE
  PAYPAL
  MANUAL
}

enum ApiKeyStatus {
  ACTIVE
  INACTIVE
  REVOKED
}

enum UserRole {
  SUPER_ADMIN
  TENANT_ADMIN
  EDITOR
}

enum IntegrationStatus {
  NOT_CONNECTED
  CONNECTED
  BLOCKED
}

enum PlatformCategory {
  LMS
  CMS
  APP_STORE
  CRM
}
